<div class="table-toolbar">
  <mat-form-field appearance="outline" class="group-by-select">
    <mat-label>Group By</mat-label>
    <mat-select [(value)]="selectedGroupBy" (selectionChange)="onGroupByChange($event.value)">
      <mat-option *ngFor="let option of groupByOptions" [value]="option.value">
        {{ option.viewValue }}
      </mat-option>
    </mat-select>
  </mat-form-field>
</div>

<div class="mat-elevation-z4 table-container">
  <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="full-width-table">

    <!-- Name Column -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Name</th>
      <td mat-cell *matCellDef="let row">{{ row.name }}</td>
    </ng-container>

    <!-- Department Column -->
    <ng-container matColumnDef="department">
      <th mat-header-cell *matHeaderCellDef>Department</th>
      <td mat-cell *matCellDef="let row">{{ departmentMap.get(row.department) }}</td>
    </ng-container>

    <!-- Role Column -->
    <ng-container matColumnDef="role">
      <th mat-header-cell *matHeaderCellDef>Role</th>
      <td mat-cell *matCellDef="let row">{{ row.role }}</td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let row">
        <span class="status-badge"
              [ngStyle]="{ 'background-color': statusMap.get(row.status)?.[1] }">
          {{ statusMap.get(row.status)?.[0] }}
        </span>
      </td>
    </ng-container>

    <!-- Actions Column -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let row">
      </td>
    </ng-container>

    <!-- Group Row -->
    <ng-container matColumnDef="group">
      <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length" class="group-cell">
        <strong>{{ row.groupName }}</strong> ({{ row.totalCountOfSubRows }} employees)
        <span class="toggle-icon">{{ row.expanded ? '▼' : '▶' }}</span>
      </td>
    </ng-container>

    <!-- Header Row -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <!-- Group Row Template-->
    <tr mat-row *matRowDef="let row; columns: ['group'] when: isGroupRow" class="group-row" (click)="row.expanded = !row.expanded">
    </tr>

    <!-- Sub Row Template -->
    <tr mat-row *matRowDef="let row; columns: displayedColumns; when: isSubRow" [class.hidden]="!row.group.expanded">
    </tr>

  </table>
</div>
